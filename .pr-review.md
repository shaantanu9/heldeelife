# PR #1 Review: P1 analysis, API auth fixes, and P1 test coverage

## Summary
The PR addresses P1 security and quality issues: admin-only access for analytics and blog revalidate, input validation on revalidate path/slug, stock-notification wired to real API, clearer TODOs, and new API tests. Overall direction is good; one breaking change must be fixed before merge.

---

## Critical: Breaking change — blog revalidate auth

**Request changes:** The new revalidate route accepts **only** session-based admin auth and **removes** support for the `x-revalidation-secret` header.

`scripts/blog-pipeline/pipeline/publisher/revalidator.py` calls this API using `x-revalidation-secret` (no browser session). After this PR, that pipeline will get **401 Unauthorized** and revalidation from the blog pipeline will break.

**Recommendation:** Keep both auth options so CI/pipeline and admin UI both work:
- If `x-revalidation-secret` header is present and matches `process.env.REVALIDATION_SECRET`, allow the request (for pipeline/CI).
- Otherwise require session and `role === 'admin'`.
- Continue to validate `slug` and `path` against the allowlists for both paths.

---

## What looks good

- **Security:** Analytics metrics and blog revalidate correctly restricted to admin; path/slug validation prevents abuse.
- **Input validation:** Revalidate route safely parses body (`request.json().catch(() => ({}))`), trims slug/path, and validates with `ALLOWED_PATH_PATTERN` and `SLUG_PATTERN`.
- **Stock notification:** Product-stock-notification now calls `/api/products/stock-alerts` with proper error handling and toast on failure.
- **Tests:** New tests for analytics metrics, blog revalidate, cart/abandoned, addresses, and products; auth and validation cases covered.
- **Docs:** P1_ISSUES_ANALYSIS.md gives a clear picture of scope, lint/typecheck, and next steps.
- **Conventions:** Matches project patterns (supabaseAdmin, getServerSession, NextResponse.json, try/catch).

---

## Minor / optional

- **revalidateTag:** Current call is `revalidateTag(\`blog-${slug}\`, 'page')`. Next.js types show `revalidateTag(tag, profile?)` — confirm that `'page'` is the intended profile for this app/cache setup.
- **Stock-alerts API:** It returns 200 even when the Supabase insert fails (only logs). Consider returning 500 or 503 on insert failure so clients can retry or show a different message.

---

## Verdict

**Changes requested** until revalidate supports both secret-based (pipeline) and admin-session auth. After that, this is good to merge.
